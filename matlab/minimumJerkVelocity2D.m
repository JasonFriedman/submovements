function [Bx,By,B,Jx,Jy,J,Hx,Hy,H] = minimumJerkVelocity2D(t0,D,Ax,Ay,t)
% MJxy - evaluate a minimum jerk curve with seperate displacement for x / y
%
% see Flash and Hogan (1985) for details on the minimum jerk equation
%
%    t0 = movement start time
%    D  = movement duration
%    Ax = displacement resulting from the movement (x)
%    Ay = displacement resulting from the movement (y)
%
% The function is evaluated at times t
%
% The function also optionally returns the first-order and second-order
% partial derivatives, for use with optimization routines
%
% Bx, By and B are the x velocity, y velocity and tangential velocities
% Jx, Jy and J are the gradients (partial derivatives) of the same quantities
% Hx, Hy and H are the Hessian (second-order partial derivatives)
%
% [Bx,By,B,Jx,Jy,J,Hx,Hy,H] = MJxy(t0,D,Ax,Ay,t)

% Jason Friedman, 2021
% www.curiousjason.com

if numel(t0)>1
    error('t0 must be a number, not a matrix');
end

if numel(D)>1
    error('D must be a number, not a matrix');
end

if numel(Ax)>1
    error('Ax must be a number, not a matrix');
end

if numel(Ay)>1
    error('Ay must be a number, not a matrix');
end


% nt is normalized time (0 <= nt <= 1)
Bx = zeros(1,numel(t));
By = zeros(1,numel(t));
B = zeros(1,numel(t));
nt = (t-t0)./D;
r = (nt>=0 & nt<=1);

Bx(r) = Ax/D * (-60 * nt(r).^3 + 30 * nt(r).^4 + 30 * nt(r).^2);
By(r) = Ay/D * (-60 * nt(r).^3 + 30 * nt(r).^4 + 30 * nt(r).^2);

A_tang = sqrt((Ax/D).^2 + (Ay/D).^2);
B(r) = A_tang * (-60 * nt(r).^3 + 30 * nt(r).^4 + 30 * nt(r).^2);

if nargout > 3
    Jx = zeros(4,numel(t));
    Jy = zeros(4,numel(t));
    J = zeros(4,numel(t));


    Jx(1,r) = Ax.*(-(60.*(t(r)-t0))./D.^3+(180.*(t(r)-t0).^2)./D.^4-(120.*(t(r)-t0).^3)./D.^5);
    Jy(1,r) = Ay.*(-(60.*(t(r)-t0))./D.^3+(180.*(t(r)-t0).^2)./D.^4-(120.*(t(r)-t0).^3)./D.^5);
    
    Jx(2,r) = Ax.*(-(90.*(t(r)-t0).^2)./D.^4+(240.*(t(r)-t0).^3)./D.^5-(150.*(t(r)-t0).^4)./D.^6);
    Jy(2,r) = Ay.*(-(90.*(t(r)-t0).^2)./D.^4+(240.*(t(r)-t0).^3)./D.^5-(150.*(t(r)-t0).^4)./D.^6);
    
    Jx(3,r) = (30.*(t(r)-t0).^2)./D.^3-(60.*(t(r)-t0).^3)./D.^4+(30.*(t(r)-t0).^4)./D.^5;
    
    Jy(4,r) = (30.*(t(r)-t0).^2)./D.^3-(60.*(t(r)-t0).^3)./D.^4+(30.*(t(r)-t0).^4)./D.^5;
    
    J(1,r) = A_tang.*(-(60.*(t(r)-t0))./D.^2+(180.*(t(r)-t0).^2)./D.^3-(120.*(t(r)-t0).^3)./D.^4);
    J(2,r) = ((-(2.*Ay.^2)./D.^3-(2.*Ax.^2)./D.^3).*((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4))./(2.*sqrt(Ay.^2./D.^2+Ax.^2./D.^2))+(-(60.*(t(r)-t0).^2)./D.^3+(180.*(t(r)-t0).^3)./D.^4-(120.*(t(r)-t0).^4)./D.^5).*A_tang;
    J(3,r) = (Ax.*((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4))./(A_tang.*D.^2);
    J(4,r) = (Ay.*((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4))./(A_tang.*D.^2);
    if nargout >6
        Hx = zeros(4,4,numel(t));
        Hy = zeros(4,4,numel(t));
        H = zeros(4,4,numel(t));
        
        Hx(1,1,r) = Ax.*(60./D.^3-(360.*(t(r)-t0))./D.^4+(360.*(t(r)-t0).^2)./D.^5);
        Hy(1,1,r) = Ay.*(60./D.^3-(360.*(t(r)-t0))./D.^4+(360.*(t(r)-t0).^2)./D.^5);
        H(1,1,r) = (60./D.^2-(360.*(t(r)-t0))./D.^3+(360.*(t(r)-t0).^2)./D.^4).*A_tang;
        
        Hx(2,1,r) = Ax.*((180.*(t(r)-t0))./D.^4-(720.*(t(r)-t0).^2)./D.^5+(600.*(t(r)-t0).^3)./D.^6);
        Hy(2,1,r) = Ay.*((180.*(t(r)-t0))./D.^4-(720.*(t(r)-t0).^2)./D.^5+(600.*(t(r)-t0).^3)./D.^6);
        H(2,1,r) = ((-(2.*Ay.^2)./D.^3-(2.*Ax.^2)./D.^3).*(-(60.*(t(r)-t0))./D.^2+(180.*(t(r)-t0).^2)./D.^3-(120.*(t(r)-t0).^3)./D.^4))./(2.*sqrt(Ay.^2./D.^2+Ax.^2./D.^2))+((120.*(t(r)-t0))./D.^3-(540.*(t(r)-t0).^2)./D.^4+(480.*(t(r)-t0).^3)./D.^5).*A_tang;
        
        Hx(3,1,r) = -(60.*(t(r)-t0))./D.^3+(180.*(t(r)-t0).^2)./D.^4-(120.*(t(r)-t0).^3)./D.^5;
        H(3,1,r) = (Ax.*(-(60.*(t(r)-t0))./D.^2+(180.*(t(r)-t0).^2)./D.^3-(120.*(t(r)-t0).^3)./D.^4))./(A_tang.*D.^2);
        
        Hy(4,1,r) = -(60.*(t(r)-t0))./D.^3+(180.*(t(r)-t0).^2)./D.^4-(120.*(t(r)-t0).^3)./D.^5;
        H(4,1,r) = (Ay.*(-(60.*(t(r)-t0))./D.^2+(180.*(t(r)-t0).^2)./D.^3-(120.*(t(r)-t0).^3)./D.^4))./(A_tang.*D.^2);
        
        Hx(1,2,r) = Ax.*((180.*(t(r)-t0))./D.^4-(720.*(t(r)-t0).^2)./D.^5+(600.*(t(r)-t0).^3)./D.^6);    
        Hy(1,2,r) = Ay.*((180.*(t(r)-t0))./D.^4-(720.*(t(r)-t0).^2)./D.^5+(600.*(t(r)-t0).^3)./D.^6);
        H(1,2,r) = ((-(2.*Ay.^2)./D.^3-(2.*Ax.^2)./D.^3).*(-(60.*(t(r)-t0))./D.^2+(180.*(t(r)-t0).^2)./D.^3-(120.*(t(r)-t0).^3)./D.^4))./(2.*sqrt(Ay.^2./D.^2+Ax.^2./D.^2))+((120.*(t(r)-t0))./D.^3-(540.*(t(r)-t0).^2)./D.^4+(480.*(t(r)-t0).^3)./D.^5).*A_tang;
        
        Hx(2,2,r) = Ax.*((360.*(t(r)-t0).^2)./D.^5-(1200.*(t(r)-t0).^3)./D.^6+(900.*(t(r)-t0).^4)./D.^7);
        Hy(2,2,r) = Ay.*((360.*(t(r)-t0).^2)./D.^5-(1200.*(t(r)-t0).^3)./D.^6+(900.*(t(r)-t0).^4)./D.^7);
        H(2,2,r) = (((6.*Ay.^2)./D.^4+(6.*Ax.^2)./D.^4).*((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4))./(2.*A_tang)-((-(2.*Ay.^2)./D.^3-(2.*Ax.^2)./D.^3).^2.*((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4))./(4.*(Ay.^2./D.^2+Ax.^2./D.^2).^(3./2)) + ...
            ((180.*(t(r)-t0).^2)./D.^4-(720.*(t(r)-t0).^3)./D.^5+(600.*(t(r)-t0).^4)./D.^6).*A_tang+((-(2.*Ay.^2)./D.^3-(2.*Ax.^2)./D.^3).*(-(60.*(t(r)-t0).^2)./D.^3+(180.*(t(r)-t0).^3)./D.^4-(120.*(t(r)-t0).^4)./D.^5))./A_tang;
        
        Hx(3,2,r) = -(90.*(t(r)-t0).^2)./D.^4+(240.*(t(r)-t0).^3)./D.^5-(150.*(t(r)-t0).^4)./D.^6;
        H(3,2,r) = -(Ax.*(-(2.*Ay.^2)./D.^3-(2.*Ax.^2)./D.^3).*((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4))./(2.*(Ay.^2./D.^2+Ax.^2./D.^2).^(3./2).*D.^2)+(Ax.*(-(60.*(t(r)-t0).^2)./D.^3+(180.*(t(r)-t0).^3)./D.^4-(120.*(t(r)-t0).^4)./D.^5))./(A_tang.*D.^2)- ...
            (2.*Ax.*((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4))./(A_tang.*D.^3);
    
        Hy(4,2,r) = -(90.*(t(r)-t0).^2)./D.^4+(240.*(t(r)-t0).^3)./D.^5-(150.*(t(r)-t0).^4)./D.^6;
        H(4,2,r) = -(Ay.*(-(2.*Ay.^2)./D.^3-(2.*Ax.^2)./D.^3).*((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4))./(2.*(Ay.^2./D.^2+Ax.^2./D.^2).^(3./2).*D.^2)+(Ay.*(-(60.*(t(r)-t0).^2)./D.^3+(180.*(t(r)-t0).^3)./D.^4-(120.*(t(r)-t0).^4)./D.^5))./(A_tang.*D.^2)- ...
            (2.*Ay.*((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4))./(A_tang.*D.^3);
        
        Hx(1,3,r) = -(60.*(t(r)-t0))./D.^3+(180.*(t(r)-t0).^2)./D.^4-(120.*(t(r)-t0).^3)./D.^5;
        H(1,3,r) = (Ax.*(-(60.*(t(r)-t0))./D.^2+(180.*(t(r)-t0).^2)./D.^3-(120.*(t(r)-t0).^3)./D.^4))./(A_tang.*D.^2);
        
        Hx(2,3,r) = -(90.*(t(r)-t0).^2)./D.^4+(240.*(t(r)-t0).^3)./D.^5-(150.*(t(r)-t0).^4)./D.^6;
        H(2,3,r) = -(Ax.*(-(2.*Ay.^2)./D.^3-(2.*Ax.^2)./D.^3).*((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4))./(2.*(Ay.^2./D.^2+Ax.^2./D.^2).^(3./2).*D.^2)+(Ax.*(-(60.*(t(r)-t0).^2)./D.^3+(180.*(t(r)-t0).^3)./D.^4-(120.*(t(r)-t0).^4)./D.^5))./(A_tang.*D.^2)- ...
            (2.*Ax.*((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4))./(A_tang.*D.^3);
        
        H(3,3,r) = ((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4)./(A_tang.*D.^2)-(Ax.^2.*((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4))./((Ay.^2./D.^2+Ax.^2./D.^2).^(3./2).*D.^4);
        
        H(4,3,r) = -(Ax.*Ay.*((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4))./((Ay.^2./D.^2+Ax.^2./D.^2).^(3./2).*D.^4);
        
        Hy(1,4,r) = -(60.*(t(r)-t0))./D.^3+(180.*(t(r)-t0).^2)./D.^4-(120.*(t(r)-t0).^3)./D.^5;
        H(1,4,r) = (Ay.*(-(60.*(t(r)-t0))./D.^2+(180.*(t(r)-t0).^2)./D.^3-(120.*(t(r)-t0).^3)./D.^4))./(A_tang.*D.^2);
        
        Hy(2,4,r) = -(90.*(t(r)-t0).^2)./D.^4+(240.*(t(r)-t0).^3)./D.^5-(150.*(t(r)-t0).^4)./D.^6;
        H(2,4,r) = -(Ay.*(-(2.*Ay.^2)./D.^3-(2.*Ax.^2)./D.^3).*((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4))./(2.*(Ay.^2./D.^2+Ax.^2./D.^2).^(3./2).*D.^2)+(Ay.*(-(60.*(t(r)-t0).^2)./D.^3+(180.*(t(r)-t0).^3)./D.^4-(120.*(t(r)-t0).^4)./D.^5))./(A_tang.*D.^2)- ...
            (2.*Ay.*((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4))./(A_tang.*D.^3);
        
        H(3,4,r) = -(Ax.*Ay.*((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4))./((Ay.^2./D.^2+Ax.^2./D.^2).^(3./2).*D.^4);
        
        H(4,4,r) = ((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4)./(A_tang.*D.^2)-(Ay.^2.*((30.*(t(r)-t0).^2)./D.^2-(60.*(t(r)-t0).^3)./D.^3+(30.*(t(r)-t0).^4)./D.^4))./((Ay.^2./D.^2+Ax.^2./D.^2).^(3./2).*D.^4);
    end
end
